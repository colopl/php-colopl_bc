name: CI Windows
on:
  workflow_call:
    inputs:
      artifact_name:
        required: true
        type: string
      artifact_run_id:
        required: true
        type: string
      archive_name:
        required: true
        type: string
jobs:
  init:
    runs-on: ubuntu-24.04
    outputs:
      needs-init: ${{ steps.check.outputs.needs-init }}
    steps:
      - name: Download prepared workspace
        uses: actions/download-artifact@v7
        with:
          name: ${{ inputs.artifact_name }}
          path: ${{ runner.temp }}/source-archive
      - name: Extract prepared workspace
        env:
          ARCHIVE_NAME: ${{ inputs.archive_name }}
        run: |
          ARCHIVE_PATH="${RUNNER_TEMP}/source-archive/${ARCHIVE_NAME}"
          tar -xzf "${ARCHIVE_PATH}" --strip-components=1 -C "${GITHUB_WORKSPACE}"
          rm -f "${ARCHIVE_PATH}"
      - name: Check if initialization is needed
        id: check
        run: |
          if test -f "ext/.gitkeep" && test "$(cat "ext/.gitkeep")" = "pskel_uninitialized"; then
            echo "needs-init=true" >> $GITHUB_OUTPUT
          else
            echo "needs-init=false" >> $GITHUB_OUTPUT
          fi
      - name: Initialize extension
        if: steps.check.outputs.needs-init == 'true'
        run: |
          docker compose run -v"$(pwd)/ext:/ext" --rm shell pskel init example
      - name: Upload initialized extension
        if: steps.check.outputs.needs-init == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: initialized-ext-windows
          path: ext/
          retention-days: 1
  Windows:
    needs: init
    runs-on: ${{ matrix.runs-on }}
    strategy:
      matrix:
        runs-on:
          - windows-2022
          - windows-2025
        version: ['8.1', '8.2', '8.3', '8.4', '8.5']
        arch: ['x64', 'x86']
        ts: ['ts', 'nts']
    steps:
      - name: Download prepared workspace
        uses: actions/download-artifact@v7
        with:
          name: ${{ inputs.artifact_name }}
          path: ${{ runner.temp }}/source-archive
      - name: Extract prepared workspace
        shell: pwsh
        env:
          ARCHIVE_NAME: ${{ inputs.archive_name }}
        run: |
          $downloadDir = Join-Path $env:RUNNER_TEMP "source-archive"
          $archivePath = Join-Path $downloadDir $env:ARCHIVE_NAME
          tar.exe -xzf $archivePath -C $env:GITHUB_WORKSPACE --strip-components=1
          Remove-Item $archivePath
      - name: Download initialized extension
        if: needs.init.outputs.needs-init == 'true'
        uses: actions/download-artifact@v7
        with:
          name: initialized-ext-windows
          path: ext\
      - name: Extract extension name
        id: ext-name
        shell: pwsh
        run: |
          $name = (Get-Content .\ext\config.w32 | Select-String "EXTENSION\('([^']+)'" | ForEach-Object { $_.Matches[0].Groups[1].Value })
          echo "name=$name" >> $env:GITHUB_OUTPUT
      - name: Setup PHP
        id: setup-php
        uses: php/setup-php-sdk@474d4e386703a8bf269c41661c6b934a751a61bf # v0.11
        with:
          version: ${{ matrix.version }}
          arch: ${{ matrix.arch }}
          ts: ${{ matrix.ts }}
          cache: true
      - name: Enable Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@0b201ec74fa43914dc39ae48a89fd1d8cb592756 # v1.13.0
        with:
          arch: ${{ matrix.arch }}
          toolset: ${{ steps.setup-php.outputs.toolset }}
      - name: phpize and configure
        run: |
          cd "ext"
          phpize
          ./configure.bat --enable-${{ steps.ext-name.outputs.name }} --with-prefix=${{ steps.setup-php.outputs.prefix }}
      - name: Build and Test
        env:
          TEST_PHP_ARGS: '-q --show-diff'
        run: |
          cd "ext"
          nmake
          nmake test
